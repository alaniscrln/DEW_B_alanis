<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ahorcado</title>
    <link rel="stylesheet" href="teclado.css">
    <link rel="stylesheet" href="partidacss.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <style>
        
    </style>
</head>

<body>

    <div class="container">
        <br>
        <div class="row">
            <div class="col-md-6">
                <h3 class="row" id="jugador"></h3>
                <h3 class="row" id="puntosJugador"></h3>
            </div>

            <div class="col-md-6">
                <h3 id="ronda">Ronda: </h3>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <br><br><br>
                <canvas width="320" height="255" id="canvas"></canvas>
            </div>

            <div class="col-md-6" id="container-pelicula" style="visibility: hidden;">
                <div class="card border-secondary mb-3">
                    <div class="card-header text-center">
                        <h4 class="" id="container-mensaje"></h4>
                    </div>
                    <div class="card-body">
                        <br>
                        <div class="row">
                            <div class="col-md-6  text-center" id="posterPelicula">
                                <img src="" alt="" id="poster">
                            </div>
                            <div class="col-md-6" id="info-pelicula">
                                <ul>
                                    <li id="tituloPelicula"></li>
                                    <li id="anioPelicula"></li>
                                    <li id="generoPelicula"></li>
                                    <li id="directorPelicula"></li>
                                    <li id="actoresPelicula"></li>
                                </ul>
                                <div class="" id="container-boton"></div>
                            </div>
                        </div>
                        <br>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="row" id="container-letrasUsadas">
                    <div class="col-12"><br><br><br><br><br></div>
                    <h4 class="letras-usadas">Letras usadas: </h4>
                    <div class="col-12"></div>
                    <h4 id="letras-usadas" class="letras-usadas"></h4>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div id="container-palabraMostrada">
                    <h2 id="guiones"></h2>
                </div>
            </div>

        </div>

        <div id="teclado">
            <div class="container-teclas" id="container-teclas">

            </div>
        </div>

    </div>

    <!--------------------------------------------------------------------------------------------------------------------->
    <script src="metodos.js"></script>
    <script>

        let rondas = localStorage.getItem("rondas");
        let jugador = new Jugador(localStorage.getItem("jugador1"), 0);
        //let jugador = jugadores[0];
        let partida = new Partida(rondas, jugador);


        function crearTeclas() {
            //fragment es un doc pequeño donde se guarda mucha info, para cuando
            //ya este todo guardado en ella, empujarlo de una al html.
            const fragment = document.createDocumentFragment();
            const letras = [
                "q", "w", "e", "r", "t", "y", "u", "i", "o", "p",
                "a", "s", "d", "f", "g", "h", "j", "k", "l", "ñ",
                "z", "x", "c", "v", "b", "n", "m"
            ];

            letras.forEach(letra => {
                btn = document.createElement("button");

                btn.setAttribute("type", "button");
                btn.classList.add("tecla");

                btn.textContent = letra;
                btn.addEventListener("click", (btn) => {
                    let mensaje = document.getElementById("container-mensaje");

                    //todavia tiene intentos y no ha adivinado la palabra
                    if (partida.errores < 6 && !haGanado()) {
                        posicionLetra(letra);   // comprobar que existe la letra en la palabra y guardar las pos donde se encuentra
                        if (posLetra.length == 0) { // si está vacio, significa q la letra era erronea
                            partida.sumarError();
                            pintarLetrasUsadas(letra);
                            pintarAhorcado(partida.errores);
                        } else {
                            pintarLetraString(letra);   // modifico string de palabraMostrada
                            pintarLetrasUsadas(letra);
                            pintarPalabraMostrada();
                        }
                    }

                    //ya ha adivinado la palabra
                    if (partida.errores < 6 && haGanado()) {
                        mensaje.style.visibility = "visible";
                        mensaje.textContent = "¡Qué bien! Has ganado esta ronda";
                        jugador.sumarPunto();
                        document.getElementById("container-pelicula").style.visibility = "visible";
                        siguientePartida();
                    }

                    //no ha adivinado la palabra y no le quedan intentos
                    if (partida.errores >= 6) {
                        mensaje.style.visibility = "visible";
                        mensaje.textContent = "¡Oh, no! Has perdido... La solución es... ";
                        document.getElementById("container-pelicula").style.visibility = "visible";
                        siguientePartida();
                    }


                });

                fragment.appendChild(btn);  // guardamos en fragment cada btn de letra

                if (letra == "p" || letra == "ñ") {   // mostrar teclado en filas
                    fragment.appendChild(document.createElement("br"));
                }

            });

            return fragment;
        }

        function getCtx() {
            var lienzo = document.getElementById("canvas");
            return lienzo.getContext('2d');
        }

        function pintarLetrasUsadas(letra) {
            document.getElementById("letras-usadas").textContent += (letra + "  ");
        }

        function pintarPalabraMostrada() {
            //para que solo aparezca una vez en pantalla
            document.getElementById("guiones").remove();

            //crear elemento
            let guiones = document.createElement("h1");
            guiones.setAttribute("id", "guiones");
            guiones.textContent = palabraMostrada;

            //crear estructura
            document.getElementById("container-palabraMostrada").appendChild(guiones);
        }

        function pintarHorca() {
            let ctx = getCtx();
            ctx.fillStyle = '#663333';
            ctx.fillRect(30, 240, 200, 9);
            ctx.fillRect(64, 9, 20, 237);
            ctx.fillRect(64, 9, 115, 20);
            ctx.fillRect(155, 9, 4, 40);
            ctx.beginPath();
            ctx.moveTo(70, 65);
            ctx.lineTo(70, 80);
            ctx.lineTo(133, 11);
            ctx.lineTo(118, 11);
            ctx.closePath();
            ctx.fill();
        }

        function pintarAhorcado(numError) {
            let ctx = getCtx();
            switch (numError) {
                case 1: //pintar cabeza
                    ctx.beginPath();
                    ctx.arc(157, 75, 25, 0, 2 * Math.PI);
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    break;
                case 2: //pintar cuerpo
                    ctx.beginPath();
                    ctx.fillStyle = 'black';
                    ctx.rect(154, 100, 3, 75);
                    ctx.fill();
                    break;
                case 3: //pintar brazo izq
                    ctx.beginPath();
                    ctx.moveTo(154, 110);
                    ctx.lineTo(125, 135);
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    break;
                case 4: //pinta brazo der
                    ctx.beginPath();
                    ctx.moveTo(156, 110);
                    ctx.lineTo(183, 135);
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    break;
                case 5: //pintar pierna izq
                    ctx.beginPath();
                    ctx.moveTo(154, 173);
                    ctx.lineTo(125, 200);
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    break;
                case 6: //pintar pierna der
                    ctx.beginPath();
                    ctx.moveTo(156, 173);
                    ctx.lineTo(183, 200);
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    break;

            }

        }

        //comprobar que la palabraMostrada no tenga ningun guion
        function haGanado() {
            let result = true;
            for (let i = 0; i < palabraMostrada.length; i++) {
                if (palabraMostrada.charAt(i) == '-') {
                    result = false;
                    i = palabraMostrada.length; // para salir del bucle
                }
            }
            return result;
        }

        function siguientePartida() {
            if (document.getElementById("btnSiguientePartida") == undefined) {  //para q solo se cree el boton una vez
                //creo el boton
                let btnSiguientePartida = document.createElement("button");
                btnSiguientePartida.setAttribute("type", "button");
                btnSiguientePartida.setAttribute("id", "btnSiguientePartida");
                btnSiguientePartida.textContent = "Siguiente Partida";
                btnSiguientePartida.classList.add("btn");
                //inserto el boton en el container
                document.getElementById("container-boton").appendChild(btnSiguientePartida);
            }

            btnSiguientePartida.addEventListener("click", () => {


                if (partida.rondaActual < partida.numRondas) {

                    console.log(partida.rondaActual + " es menor igual que " + partida.numRondas)
                    // establecer todo para la nueva partida
                    partida.siguienteRonda();
                    init();

                } else {    // ya se ha terminado la partida
                    console.log(partida.rondaActual + " es mayor que " + partida.numRondas);

                    localStorage.setItem("puntos-jugador1", jugador.getPuntos());
                    if (jugador.puntos < (partida.numRondas / 2)) {
                        //ha perdido la partida
                        window.location.href = './hasPerdido.html';
                    } else {
                        //ha ganado la partida
                        window.location.href = './hasGanado.html';
                    }
                }



                document.getElementById("container-mensaje").style.visibility = "hidden";

            });
        }

        function actualizarCanvas(ctx) {
            var lienzo = document.getElementById("canvas");
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, lienzo.width, lienzo.height); //Esto es para limpiar el canvas
            pintarHorca();
        }

        function pintarDatosPelicula(poster, titulo, anio, genero, director, actores) {
            let posterPelicula = document.getElementById("posterPelicula");
            let tituloPelicula = document.getElementById("tituloPelicula");
            let anioPelicula = document.getElementById("anioPelicula");
            let generoPelicula = document.getElementById("generoPelicula");
            let directorPelicula = document.getElementById("directorPelicula");
            let actoresPelicula = document.getElementById("actoresPelicula");

            document.getElementById("poster").remove();
            let imagen = document.createElement("img");
            imagen.setAttribute("src", poster);
            imagen.setAttribute("alt", titulo);
            imagen.setAttribute("id", "poster");
            imagen.setAttribute("height", "270");

            posterPelicula.appendChild(imagen);
            tituloPelicula.textContent = "Título: " + titulo;
            anioPelicula.textContent = "Lanzamiento: " + anio;
            generoPelicula.textContent = "Género: " + genero;
            directorPelicula.textContent = "Director: " + director;
            actoresPelicula.textContent = "Actores principales: " + actores;

            document.getElementById("container-pelicula").style.visibility = "hidden";


        }


        //establecer valores iniciales y cargar palabra aleatoria
        function cargarInfo() {
            document.getElementById("ronda").textContent = "Ronda: " + partida.rondaActual;
            document.getElementById("letras-usadas").textContent = "";
            document.getElementById("jugador").textContent = "Jugando: " + jugador.getNombre();
            document.getElementById("puntosJugador").textContent = "Puntos: " + jugador.getPuntos();
            partida.resetearErrores();
            actualizarCanvas(getCtx());

            //para no repetir el teclado
            document.getElementById("container-teclas").remove();
            let container_teclas = document.createElement("div");
            container_teclas.setAttribute("class", "container-teclas");
            container_teclas.setAttribute("id", "container-teclas");
            container_teclas.appendChild(crearTeclas());
            document.getElementById("teclado").appendChild(container_teclas);

        }




        function init() {

            cargarInfo();

            fetch("peliculas.json")
                .then(function (respuesta) {
                    return respuesta.json();
                })
                .then(function (peliculas) {

                    let pelicula = peliculas[(Math.random() * peliculas.length) | 0];   //index aleatorio

                    guardarPalabra(pelicula.titulo.toLowerCase());
                    pintarGuiones();
                    pintarPalabraMostrada();
                    pintarDatosPelicula(pelicula.poster, pelicula.titulo, pelicula.fecha_lanzamiento,
                        pelicula.genero, pelicula.director, pelicula.actores);



                    console.log("Partida actual: " + partida.rondaActual + ", num de rondas: " + partida.numRondas);

                });

        }

        window.addEventListener("load", init());

    </script>


</body>

</html>